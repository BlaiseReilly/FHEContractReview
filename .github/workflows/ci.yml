name: Continuous Integration

on:
  push:
    branches:
      - main
      - develop
      - master
  pull_request:
    branches:
      - main
      - develop
      - master

jobs:
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Prettier check
        run: npm run format:check

      - name: Run Solhint
        run: npm run lint:sol

      - name: Run ESLint
        run: npm run lint:js
        continue-on-error: true

  compile:
    name: Compile Contracts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npm run compile

      - name: Check contract sizes
        run: |
          echo "## Contract Sizes" > contract-sizes.md
          if [ -d "artifacts/contracts" ]; then
            find artifacts/contracts -name "*.json" -not -path "*/build-info/*" | while read file; do
              size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo "0")
              echo "- $(basename $file): $size bytes" >> contract-sizes.md
            done
          fi
          cat contract-sizes.md

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: compiled-contracts
          path: |
            artifacts/
            cache/
          retention-days: 7

  test-matrix:
    name: Test on Node ${{ matrix.node }} / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        node: [18.x, 20.x]
        os: [ubuntu-latest]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npm run compile

      - name: Run tests
        run: npm test

  build-check:
    name: Build and Deploy Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile contracts
        run: npm run compile

      - name: Check deployment scripts
        run: |
          echo "Verifying deployment scripts..."
          test -f scripts/deploy.js && echo "✅ deploy.js exists"
          test -f scripts/verify.js && echo "✅ verify.js exists"
          test -f scripts/interact.js && echo "✅ interact.js exists"
          test -f scripts/simulate.js && echo "✅ simulate.js exists"

      - name: Check configuration files
        run: |
          echo "Verifying configuration files..."
          test -f hardhat.config.js && echo "✅ hardhat.config.js exists"
          test -f .env.example && echo "✅ .env.example exists"
          test -f .prettierrc.json && echo "✅ .prettierrc.json exists"
          test -f .solhint.json && echo "✅ .solhint.json exists"

  all-checks-pass:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, compile, test-matrix, build-check]

    steps:
      - name: Verify all jobs passed
        run: |
          echo "✅ All CI checks passed successfully!"
          echo "- Code quality checks: PASS"
          echo "- Contract compilation: PASS"
          echo "- Test matrix: PASS"
          echo "- Build verification: PASS"
